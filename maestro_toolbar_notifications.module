<?php

/**
 * @file
 * Adds a Maestro notification to the Drupal toolbar
 */

/**
 * Implements hook_menu().
 */
function maestro_toolbar_notifications_menu() {
  $items['admin/notifications'] = array(
    'title' => 'Notifications',
    'page callback' => 'maestro_toolbar_notifications_page',
    'access callback' => 'maestro_toolbar_notifications_access',
    'weight' => -16,
  );

  return $items;
}

/**
 * Returns true when user has permissions to both
 * 'maestro taskconsole' and 'access toolbar'.
 */
function maestro_toolbar_notifications_access() {
  if (user_access('maestro taskconsole') && user_access('access toolbar')) {
    return TRUE;
  }
  else {
    return FALSE;
  }
}

/**
 * Implements hook_init().
 * Grabs the notifications for the current user and
 * sends them to the Drupal.settings js object.
 */
function maestro_toolbar_notifications_preprocess(&$variables, $hook) {
  // Load maestro.moderator.inc from the maestro module.
  module_load_include('inc', 'maestro', 'maestro.moderator');

  $result = db_query(maestro_get_all_flows_data(array('myflows' => TRUE)));

  $notification_count = 0;

  foreach ($result as $record) {
    $notification_count++;
  }

  if ($notification_count == 1) {
    $notification_term = t('Notification');
  }
  else {
    $notification_term = t('Notifications');
  }
  drupal_add_js(array(
    'maestro_toolbar_notifications' => array(
      'notification' => $notification_count . ' ' . $notification_term,
    ),
  ), 'setting');
}

function maestro_toolbar_notifications_page() {
  menu_set_active_item('maestro/myflows');
  return menu_execute_active_handler(NULL, FALSE);
}
